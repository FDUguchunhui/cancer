---
title: "step3 calculate the rests"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(summarytools)
```


```{r}
load('data/rawdata2.Rdata')
```

```{r}
# data rawdata3; set rawdata2;
# N_comorbity=sum(Chronic_Kidney_Disease,
# Chronic_Obstructive_Pulmonary,Down_Syndrome,
# Solid_Organ_Transplant,
# obesity01,pregnancy,
# Heart_Failure,Coronary_Artery_Disease, 
# Cardiomyopathies,
# Sickle_Cell_Disease,smoke_yn,Type_2_Diabetes_Mellitus);
# 
# N_Posi_Comorb=sum(Asthma,Cerebrovascular,Cystic_Fibrosis,
# Hypertension,Other_Immuno,Liver_Disease,Dementia,
# overweight01,Pulmonary_Fibrosis,Thalassemia,Type_1_Diabetes_Mellitus);

rawdata3 <- rawdata2 %>% 
  rowwise() %>% 
  mutate(n_comorbity = sum(chronic_kidney_disease, chronic_obstructive_pulmonary,down_syndrome, solid_organ_transplant,                              obesity01,pregnancy, heart_failure,coronary_artery_disease, cardiomyopathies, sickle_cell_disease, smoke_yn, type_2_diabetes_mellitus),

        n_posi_comorb=sum(asthma,cerebrovascular,cystic_fibrosis,
hypertension,other_immuno,liver_disease,dementia,
overweight01,pulmonary_fibrosis,thalassemia,type_1_diabetes_mellitus))
```


```{r}
# if N_comorbity>=4 then N_comorbity_gp=">=4";
# else if N_comorbity=3 then N_comorbity_gp="3";
# else if N_comorbity=2 then N_comorbity_gp="2"; 
# else if N_comorbity=1 then N_comorbity_gp="1";
# else if N_comorbity~=. then N_comorbity_gp="0";
# 
# if N_Posi_Comorb>=4 then N_Posi_Comorb_gp=">=4";
# else if N_Posi_Comorb=3 then N_Posi_Comorb_gp="3";
# else if N_Posi_Comorb=2 then N_Posi_Comorb_gp="2";
# else if N_Posi_Comorb=1 then N_Posi_Comorb_gp="1";
# else if N_Posi_Comorb~=. then N_Posi_Comorb_gp="0";


# create categorized n_comorbity variable and n_posi_comorb
rawdata3 <- rawdata3 %>% 
  mutate(n_comorbity_gp = ifelse(is.na(n_comorbity), NA, 
                                       ifelse(n_comorbity >= 4, '>=4',
                                              ifelse(n_comorbity == 3, '3',
                                                     ifelse(n_comorbity == 2, '2',
                                                            ifelse(n_comorbity == 1, '1', '0')
                                                            )
                                                     )
                                              )
                                 ),
         n_posi_comorb_gp = ifelse(is.na(n_posi_comorb), NA, 
                                       ifelse(n_posi_comorb >= 4, '>=4',
                                              ifelse(n_posi_comorb == 3, '3',
                                                     ifelse(n_posi_comorb == 2, '2',
                                                            ifelse(n_posi_comorb == 1, '1', '0')
                                                            )
                                                     )
                                              )
                                 )
         )
```

#bug!!!!!!!!!!!!!
```{r}
# if MA_Cytotoxic_4w=1 or PS_Cytotoxic_4w=1 or PR_Cytotoxic_4w=1 then cytotoxic_4wk="Y";
# else cytotoxic_4wk="N";
# 
# if MA_Non_Cytotoxic_4w=1 or PS_Non_Cytotoxic_4w=1 or PR_Non_Cytotoxic_4w=1 then Nocytotoxic_4wk="Y";
# else Nocytotoxic_4wk="N";
#


# if cytotoxic_4wk="Y" then cytotoxic4wk="a. cytotoxic  ";                         # extra whitespace


# else if Nocytotoxic_4wk="Y" then cytotoxic4wk="b. no cytotoxic";                 
# else cytotoxic4wk="c. no chemo drug";
# 
# *combine cytotoxic drug;
# if cytotoxic4wk in ("a. cytotoxic","b. no cytotoxi") then chemo_4w=1;            # variable value not match
# else if cytotoxic4wk="c. no chemo dr" then chemo_4w=0;                           # variablke value not match (c. no chemo dr)
# 
# run;


rawdata3 <- rawdata3 %>% 
  rowwise() %>% 
  # if NA is encountered in condition statement, NA will be return directly
  mutate(cytotoxic_4wk = ifelse(ma_cytotoxic_4w == 1 || ps_cytotoxic_4w == 1 || pr_cytotoxic_4w == 1, 'Y', 'N'),
         nocytotoxic_4wk = ifelse(ma_non_cytotoxic_4w == 1 || ps_non_cytotoxic_4w == 1 || pr_non_cytotoxic_4w == 1, 'Y', 'N'),
         cytotoxic4wk = ifelse(cytotoxic_4wk == 'Y', 'a. cytotoxic', 
                               ifelse(nocytotoxic_4wk == 'Y', 'b. no cytotoxic', 'c. no chemo drug')),
         # combine cytotoxic drug
         chemo_4w = ifelse(cytotoxic4wk %in% c("a. cytotoxic", "b. no cytotoxic"), 1, 
                           ifelse(cytotoxic4wk == 'c. no chemo drug', 0, NA))
         
         )

```



proc freq data=rawdata3;
tables N_comorbity_gp  N_Posi_Comorb_gp cytotoxic_4wk
Nocytotoxic_4wk cytotoxic4wk chemo_4w;
where cancer=1;
run;
/*
proc freq data=rawdata2;
tables       Chronic_Kidney_Disease 
Chronic_Obstructive_Pulmonary Down_Syndrome 
Solid_Organ_Transplant 
obesity01 pregnancy 
Heart_Failure Coronary_Artery_Disease  
Cardiomyopathies 
Sickle_Cell_Disease smoke_yn Type_2_Diabetes_Mellitus
Asthma Cerebrovascular Cystic_Fibrosis 
Hypertension Other_Immuno Liver_Disease Dementia 
overweight01 Pulmonary_Fibrosis Thalassemia Type_1_Diabetes_Mellitus
;
run;*/
```{r}
vars <- c('n_comorbity_gp', 'n_posi_comorb_gp', 'cytotoxic_4wk', 'nocytotoxic_4wk', 'cytotoxic4wk', 'chemo_4w')
for (var in vars) {
  print(var)
  print(freq(x = rawdata3[rawdata3$cancer == 1, ][[var]]))
}
```

```{r}
# data rawdata4;
# set rawdata3; 
# cancer_year=year(cancer_date);
# 
# age_at_cancer=(cancer_year-BIRTH_YR);
# 
# duration=(COVID_diag_date-cancer_date)/365.25;
# if duration>5 then survive_5yr_more=1;
# else if duration<=5 and duration>=0 then survive_5yr_more=0;
# if cancer=0 then survive_5yr_more=.;
# 
# *IF the cancer occur before covid, then need to be labeled and deleted later;
# if duration<0 and duration~=. then cancer_after_COVID=1;
# 
# if age_at_cancer>=0 and age_at_cancer<20 then age_cancer_gp="0-20  ";
# else if age_at_cancer>=20 and age_at_cancer<40 then age_cancer_gp="20-40";
# else if age_at_cancer>=40 and age_at_cancer<60 then age_cancer_gp="40-60";
# else if age_at_cancer>=60 and age_at_cancer<80 then age_cancer_gp="60-80";
# else if age_at_cancer>=80 then age_cancer_gp=">=80";
# else age_cancer_gp="miss";


rawdata3 <- rawdata3 %>% 
  mutate(cancer_year = as.numeric(format(`cancer_date`, "%Y")),
         age_at_cancer = (cancer_year - birth_year),
         duration=(`covid diag date` - cancer_date)/365.25,
         
         survive_5yr_more = ifelse(duration > 5, 1, 
                                   ifelse(duration >=0 && duration <=5, 0, NA)),
         # override survive_5yr_more with special condition
         survive_5yr_more = ifelse(cancer == 0, NA, survive_5yr_more),
         
          cancer_after_covid
         
         cancer_after_covid = ifelse(age_at_cancer >= 0 && age_at_cancer < 20, )
         )





```


